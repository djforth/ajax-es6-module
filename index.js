(function(global,factory){if('function'==typeof define&&define.amd)define(['exports','lodash/isFunction','lodash/forEach','lodash/isString','lodash/isUndefined','lodash/isArray','lodash/union'],factory);else if('undefined'!=typeof exports)factory(exports,require('lodash/isFunction'),require('lodash/forEach'),require('lodash/isString'),require('lodash/isUndefined'),require('lodash/isArray'),require('lodash/union'));else{var mod={exports:{}};factory(mod.exports,global.isFunction,global.forEach,global.isString,global.isUndefined,global.isArray,global.union),global.index=mod.exports}})(this,function(exports,_isFunction2,_forEach2,_isString2,_isUndefined2,_isArray2,_union){'use strict';function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError('Cannot call a class as a function')}Object.defineProperty(exports,'__esModule',{value:!0});var _isFunction3=_interopRequireDefault(_isFunction2),_forEach3=_interopRequireDefault(_forEach2),_isString3=_interopRequireDefault(_isString2),_isUndefined3=_interopRequireDefault(_isUndefined2),_isArray3=_interopRequireDefault(_isArray2),_union2=_interopRequireDefault(_union),_createClass=function(){function defineProperties(target,props){for(var descriptor,i=0;i<props.length;i++)descriptor=props[i],descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,'value'in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),AjaxPromises=function(){function AjaxPromises(url){_classCallCheck(this,AjaxPromises),this.uri=url||null,this.state='GET',this.data=[],this.headers=[]}return _createClass(AjaxPromises,[{key:'addRailsJSHeader',value:function(){this.addHeaders([{header:'Content-type',value:'application/json'},{header:'accept',value:'*/*;q=0.5, text/javascript, application/javascript, application/ecmascript, application/x-ecmascript'}])}},{key:'addHeaders',value:function(token){(0,_isArray3.default)(token)?this.headers=(0,_union2.default)(token,this.headers):this.headers.push(token)}},{key:'addID',value:function(id){return(0,_isUndefined3.default)(id)?this.uri:this.uri.match(/.json/)?this.uri.replace('.json','/'+id+'.json'):this.uri+'/'+id}},{key:'addUrl',value:function(url){if(!(0,_isString3.default)(url))throw new Error('URL must be a string');this.uri=url}}]),_createClass(AjaxPromises,[{key:'create',value:function(data,progress){return this.state='POST',new Promise(function(resolve,reject){this.getRequest(resolve,reject,progress,data)}.bind(this))}},{key:'destroy',value:function(id,progress){this.state='POST';var crsf=this.getCSRF();this.addRailsJSHeader(),this.addHeaders({header:'X-Http-Method-Override',value:'delete'});var del={_method:'delete'};return del[crsf.param]=crsf.token,new Promise(function(resolve,reject){this.getRequest(resolve,reject,progress,del,id)}.bind(this))}},{key:'fetch',value:function(progress){return this.state='GET',new Promise(function(resolve,reject){this.getRequest(resolve,reject,progress)}.bind(this))}},{key:'getCSRF',value:function(){var token=document.querySelector('meta[name=csrf-token]'),param=document.querySelector('meta[name=csrf-param]');return token&&this.headers.push({header:'X-CSRF-Token',value:token.content}),{token:token.content,param:param.content}}},{key:'getData',value:function(){return this.data}},{key:'getID',value:function(data,id){return id?id:data.id}},{key:'getRequest',value:function(resolve,reject,progress,send,id){if(this.url)throw new Error('URL not set');var xhr=this.setRequest(resolve,reject,progress),data=send?JSON.stringify(send):null;xhr.open(this.state,this.addID(id),!0),this.setHeaders(xhr),xhr.send(data)}},{key:'parseData',value:function(data){return(0,_isUndefined3.default)(data)||(this.data=JSON.parse(data)),this.data}},{key:'update',value:function(data,id,progress){return this.state='PUT',new Promise(function(resolve,reject){this.getRequest(resolve,reject,progress,data,this.getID(data,id))}.bind(this))}},{key:'readyState',value:function(xhr,resolve,reject){200!==xhr.status&&0!==xhr.status&&reject(new Error(xhr.statusText)),4===xhr.readyState&&(this.parseData(xhr.responseText),resolve(this.getData()))}},{key:'setHeaders',value:function(xhr,headers){headers&&this.addHeaders(headers),(0,_forEach3.default)(this.headers,function(h){xhr.setRequestHeader(h.header,h.value)})}},{key:'setProgress',value:function(evt,progress){evt.lengthComputable?progress({percent:100*(evt.loaded/evt.total),loaded:evt.loaded,total:evt.total}):progress({percent:100,loaded:evt.loaded,total:evt.loaded})}},{key:'setRequest',value:function(resolve,reject,progress){var xhr=new XMLHttpRequest;return(0,_isFunction3.default)(progress)&&(xhr.onprogress=function(){(0,_isFunction3.default)(progress)&&this.setProgress(xhr,progress)}.bind(this)),xhr.onreadystatechange=function(){this.readyState(xhr,resolve,reject)}.bind(this),xhr.onerror=function(){reject(Error('Network Error'))},xhr}}]),AjaxPromises}();exports.default=AjaxPromises});
